name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Extract version from Xcode project
        id: version
        run: |
          # Extract MARKETING_VERSION from the Release configuration
          # Method 1: Use xcodebuild (most reliable)
          MARKETING_VERSION=$(xcodebuild -project VirtualDisplay.xcodeproj -scheme VirtualDisplay -configuration Release -showBuildSettings 2>/dev/null | grep "MARKETING_VERSION" | head -1 | sed 's/.*MARKETING_VERSION = //' | tr -d ' ')
          if [ -z "$MARKETING_VERSION" ]; then
            # Method 2: Parse project.pbxproj - find MARKETING_VERSION in the buildSettings block that precedes "name = Release"
            MARKETING_VERSION=$(awk '/buildSettings = \{/{flag=1; version=""} flag && /MARKETING_VERSION/{match($0, /MARKETING_VERSION = ([^;]+)/, arr); version=arr[1]} flag && /name = Release/{gsub(/^[ \t]+|[ \t]+$/, "", version); print version; exit} flag && /^[[:space:]]*\};/{flag=0}' VirtualDisplay.xcodeproj/project.pbxproj | tr -d ' ')
          fi
          if [ -z "$MARKETING_VERSION" ]; then
            # Method 3: Simple grep - find MARKETING_VERSION closest to "name = Release" in Release config
            MARKETING_VERSION=$(grep -B 100 "name = Release" VirtualDisplay.xcodeproj/project.pbxproj | grep "MARKETING_VERSION" | tail -1 | sed 's/.*MARKETING_VERSION = //;s/;//' | tr -d ' ')
          fi
          if [ -z "$MARKETING_VERSION" ]; then
            echo "Error: Could not extract MARKETING_VERSION"
            exit 1
          fi
          echo "version=$MARKETING_VERSION" >> $GITHUB_OUTPUT
          echo "Marketing version: $MARKETING_VERSION"

      - name: Build app (no code signing)
        run: |
          xcodebuild -project VirtualDisplay.xcodeproj \
            -scheme VirtualDisplay \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            clean build

      - name: Import Code Signing Certificate
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          CERTIFICATE_PATH="$RUNNER_TEMP/certificate.p12"
          echo "$CERTIFICATE_BASE64" | base64 --decode -o "$CERTIFICATE_PATH"

          security import "$CERTIFICATE_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # IMPORTANT: add the keychain to the search list (plural)
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -s "$KEYCHAIN_PATH"

          # Allow codesign to access the keychain without UI prompts
          security set-key-partition-list -S apple-tool:,apple:,codesign: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Show available code signing identities (diagnostic)
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        run: |
          security find-identity -v -p codesigning

      - name: Create app bundle
        run: |
          BUILT_APP=$(find build -name "MirageVD.app" -type d | head -1)
          if [ -z "$BUILT_APP" ]; then
            echo "Error: Could not find MirageVD.app"
            exit 1
          fi
          cp -r "$BUILT_APP" ./MirageVD.app
          echo "App bundle created successfully"

      - name: Code Sign App
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          APP_NAME="MirageVD"

          # Re-unlock keychain in this step (common CI requirement)
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"

          echo "Signing app with identity: $APPLE_SIGNING_IDENTITY"
          codesign --deep --force --verify --verbose \
            --sign "$APPLE_SIGNING_IDENTITY" \
            --options runtime \
            --timestamp \
            "${APP_NAME}.app"

          codesign --verify --verbose=4 "${APP_NAME}.app"
          echo "App signed successfully"

      - name: Notarize App
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          APP_NAME="MirageVD"

          echo "Notarizing app with Apple..."

          ditto -c -k --keepParent "${APP_NAME}.app" "${APP_NAME}.zip"

          xcrun notarytool submit "${APP_NAME}.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          xcrun stapler staple "${APP_NAME}.app"
          rm -f "${APP_NAME}.zip"

          echo "App notarized and stapled successfully"

      - name: Create DMG
        run: |
          APP_NAME="MirageVD"
          VERSION="${{ steps.version.outputs.version }}"

          mkdir -p dmg_temp
          cp -r "${APP_NAME}.app" dmg_temp/
          ln -s /Applications dmg_temp/Applications

          hdiutil create -volname "$APP_NAME" \
            -srcfolder dmg_temp \
            -ov -format UDZO \
            "${APP_NAME}-${VERSION}.dmg"

          rm -rf dmg_temp

          echo "DMG created: ${APP_NAME}-${VERSION}.dmg"
          ls -lh "${APP_NAME}-${VERSION}.dmg"

      - name: Sign DMG
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          APP_NAME="MirageVD"
          VERSION="${{ steps.version.outputs.version }}"

          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "Signing DMG..."
          codesign --force --sign "$APPLE_SIGNING_IDENTITY" \
            --timestamp "${APP_NAME}-${VERSION}.dmg"

          codesign --verify --verbose=4 "${APP_NAME}-${VERSION}.dmg"
          echo "DMG signed successfully"

      # - name: Create PKG installer
      #   run: |
      #     APP_NAME="MirageVD"
      #     IDENTIFIER="me.ahmadhajjar.MirageVD"
      #     VERSION="${{ steps.version.outputs.version }}"

      #     pkgbuild --root "${APP_NAME}.app" \
      #       --install-location "/Applications" \
      #       --identifier "$IDENTIFIER" \
      #       --version "$VERSION" \
      #       "${APP_NAME}-${VERSION}.pkg"

      #     echo "PKG created: ${APP_NAME}-${VERSION}.pkg"
      #     ls -lh "${APP_NAME}-${VERSION}.pkg"

      # - name: Sign PKG
      #   if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') }}
      #   env:
      #     APPLE_INSTALLER_IDENTITY: ${{ secrets.APPLE_INSTALLER_IDENTITY }}
      #   run: |
      #     APP_NAME="MirageVD"
      #     VERSION="${{ steps.version.outputs.version }}"

      #     echo "Signing PKG..."
      #     productsign --sign "$APPLE_INSTALLER_IDENTITY" \
      #       "${APP_NAME}-${VERSION}.pkg" \
      #       "${APP_NAME}-${VERSION}-signed.pkg"

      #     mv "${APP_NAME}-${VERSION}-signed.pkg" "${APP_NAME}-${VERSION}.pkg"

      #     pkgutil --check-signature "${APP_NAME}-${VERSION}.pkg"
      #     echo "PKG signed successfully"

      - name: Generate release notes
        id: release_notes
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [ -n "$APPLE_SIGNING_IDENTITY" ] && [ -n "$APPLE_ID" ]; then
            NOTARIZED_STATUS="This release is code-signed and notarized by Apple."
          elif [ -n "$APPLE_SIGNING_IDENTITY" ]; then
            NOTARIZED_STATUS="This release is code-signed but not notarized. You may see security warnings when opening the app."
          else
            NOTARIZED_STATUS="This release is not code-signed or notarized. You may see security warnings when opening the app."
          fi

          cat > release_notes.md << EOF
          ## MirageVD ${VERSION}

          ${NOTARIZED_STATUS}

          ### Installation

          DMG Installer
          1. Download \`MirageVD-${VERSION}.dmg\`
          2. Open the DMG file
          3. Drag MirageVD to your Applications folder

          ### What's New
          See commit history for details.

          ### System Requirements
          - macOS 10.15 or later
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: MirageVD ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            MirageVD-${{ steps.version.outputs.version }}.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
